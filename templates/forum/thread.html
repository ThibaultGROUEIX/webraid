{% extends 'base.html' %}
{% load bootstrapify %}
{% load staticfiles %}
{% load helper_tags %}
{% block extrahead %}
    <script src="{% static 'js/customformats.js' %}" type="text/javascript"></script>
{% endblock %}

{% block path %}
    <a href="{% url 'forum' %}">forum</a> /
    {% pretty_thread_path thread %}
{% endblock %}

{% block content %}
    {% if post_list.count > 4 %}
        <a href="#new-post-form" class="btn"><i class="fa fa-fw fa-arrow-down"></i> Derniers posts</a>
    {% endif %}
    <ul class="list">
        {% for post in post_list %}
            <li class="post-container">
                <div class="panel--post {% if user == post.author.user %}self{% else %}other{% endif %}"
                     id="post-{{ post.id }}"
                        >
                    <span hidden class="username">{{ post.author.user.username }}</span>
                    {% if post == edit_post %}
                        <form id="post-edit-form"
                              method="POST"
                              action="{% url 'detail_thread_edit_post' category_slug slug edit_post.pk %}"
                                >
                            {% csrf_token %}
                            <div class="panel-body--post">
                                {{ edit_post_form.text_content | bs_form_input:"" }}
                                {{ edit_post_form.file }}
                            </div>
                            <div class="panel-footer--post">
                                <input type="submit" class="btn btn-default" value="Valider" name="edit-post">
                            </div>
                        </form>
                    {% else %}
                        {% if user != post.author.user %}
                            <div class="panel-title--post">
                                {{ post.author.user.first_name }} {{ post.author.user.last_name }}
                            </div>
                        {% endif %}
                        <div class="panel-body--post">
                            <p>{{ post.text_content }}</p>
                        </div>
                        <div class="panel-footer--post">
                            posté le {{ post.posted_date | date }}
                            {% if post.posted_date.date != post.last_edit_date.date %}
                                , dernière édition le {{ post.last_edit_date | date }}
                            {% endif %}
                            {% if user == post.author.user %}
                                <a class="btn-sm"
                                   href="{% url 'detail_thread_edit_post' category_slug slug post.pk %}#post-edit-form">
                                    edit
                                </a>
                                <a class="btn-sm"
                                   href="{% url 'detail_thread_delete_post' post.id %}">
                                    delete
                                </a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </li>
        {% endfor %}
    </ul>
    {% if post_list.count > 0 %}
        <div class="searchbar-fixed-top">
            {% input_fuzzy_search "Filtrer par nom d'utilisateur" %}
        </div>
    {% endif %}
    <p>
    <div class="panel--post new" id="new-post-form">
        <form method="POST" action="{% url 'detail_thread' category_slug slug %}">
            {% csrf_token %}
            {{ form.text_content | bs_form_input:"" }}
            {{ form.file | bs_file_input }}
            <input type="submit" class="btn btn-default" value="Poster" name="new-post">
        </form>
    </div>
    </p>
    <!-- Scroll-up -->
    <div class="scroll-up">
        <ul>
            <li><a href="#header"><i class="fa fa-angle-up"></i></a></li>
        </ul>
    </div>
{% endblock %}

{% block extrajs %}
    <script src="{% static 'js/linkify.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/linkify-jquery.min.js' %}" type="text/javascript"></script>
    <script>$('p').linkify();</script>
    {% init_fuzzy_search "content" "'username'" %}
    <!-- Enable tagging with @ -->
    <script>
        $.getJSON("/users_json", function (data) {
                    $('textarea').triggeredAutocomplete({
                                hidden: '#hidden_inputbox',
                                source: data,
                                trigger: '@',
                                maxLength: 30
                            }
                    )
                }
        );
    </script>
{% endblock %}